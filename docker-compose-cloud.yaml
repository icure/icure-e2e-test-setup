version: "3.8"

services:
  couchdb:
    image: couchdb:3.2.2
    container_name: couchdb-test
    ports:
      - "${COUCHDB_PORT}:5984"
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}

  kraken-1:
    image: docker.taktik.be/icure/icure-kraken:${AS_VERSION:-latest}
    container_name: icure-oss-test-1
    ports:
      - "5005:5005"
      - "16044:16043"
    environment:
      - ICURE_COUCHDB_URL=http://couchdb-test:5984
      - ICURE_COUCHDB_USERNAME=${COUCHDB_USER}
      - ICURE_COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - ICURE_AUTHENTICATION_LOCAL=true
    depends_on:
      - couchdb

  kraken-2:
    image: docker.taktik.be/icure/icure-kraken:${AS_VERSION:-latest}
    container_name: icure-oss-test-2
    ports:
      - "5006:5005"
      - "16045:16043"
    environment:
      - ICURE_COUCHDB_URL=http://couchdb-test:5984
      - ICURE_COUCHDB_USERNAME=${COUCHDB_USER}
      - ICURE_COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - ICURE_AUTHENTICATION_LOCAL=true
    depends_on:
      - couchdb

  haproxy:
    image: docker.taktik.be/haproxy:2.4.17
    restart: always
    volumes:
      - ./haproxy/:/etc/haproxy/
    ports:
      - "8080:8080"

  mock-msg-gw:
    image: docker.taktik.be/icure/mock:0.1.5-gd5c69a6ee4
    container_name: mock
    ports:
      - "8081:8080"
    profiles:
      - mock

# => ./haproxy/haproxy.cfg
# global
#   stats socket /var/run/api.sock user haproxy group haproxy mode 660 level admin expose-fd listeners
#   log stdout format raw local0 info
# defaults
#   log global
#   option dontlognull
#   option http-server-close
#   timeout client 5m
#   timeout client-fin 50s
#   timeout connect 5s
#   timeout server 1d
#   timeout tunnel 20m
#   mode http
# frontend stats
#   bind *:16046
#   stats enable
#   stats uri /
#   stats refresh 10s
# frontend myfrontend
#   bind :8080
#   default_backend webservers
# backend webservers
#   option redispatch
#   server k1 kraken-1:16043 check
#   server k2 kraken-2:16043 check
